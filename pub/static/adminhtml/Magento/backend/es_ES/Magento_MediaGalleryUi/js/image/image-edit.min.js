define(['jquery','underscore','uiComponent','uiLayout','Magento_Ui/js/lib/key-codes','Magento_MediaGalleryUi/js/action/getDetails','mage/validation'],function($,_,Component,layout,keyCodes,getDetails){'use strict';return Component.extend({defaults:{template:'Magento_MediaGalleryUi/image/image-edit',modalSelector:'.media-gallery-edit-image-details-modal',imageEditDetailsUrl:'/media_gallery/image/details',saveDetailsUrl:'/media_gallery/image/saveDetails',images:[],image:null,keywordOptions:[],selectedKeywords:[],newKeyword:'',newKeywordSelector:'#keyword',modules:{mediaGridMessages:'${ $.mediaGridMessages }',keywordsSelect:'${ $.name }_keywords'},viewConfig:[{component:'Magento_Ui/js/form/element/ui-select',name:'${ $.name }_keywords',template:'ui/grid/filters/elements/ui-select',disableLabel:true}],exports:{keywordOptions:'${ $.name }_keywords:options'},links:{selectedKeywords:'${ $.name }_keywords:value'}},initialize:function(){this._super().initView();return this;},addKeyword:function(){var options=this.keywordOptions(),selected=this.selectedKeywords(),newKeywordField=$(this.newKeywordSelector);newKeywordField.validation();if(!newKeywordField.validation('isValid')||this.newKeyword()===''){return;}
options.push(this.getOptionForKeyword(this.newKeyword()));selected.push(this.newKeyword());this.newKeyword('');this.keywordOptions(options);this.selectedKeywords(selected);},getOptionForKeyword:function(keyword){return{'is_active':1,level:1,value:keyword,label:keyword};},setKeywordOptions:function(tags){var options=[];tags.forEach(function(tag){options.push(this.getOptionForKeyword(tag));}.bind(this));this.keywordOptions(options);this.selectedKeywords(tags);},initView:function(){layout(this.viewConfig);return this;},initObservable:function(){this._super().observe(['image','keywordOptions','selectedKeywords','newKeyword']);return this;},showEditDetailsPanel:function(imageId){if(_.isUndefined(this.images[imageId])){getDetails(this.imageEditDetailsUrl,[imageId]).then(function(imageDetails){this.images[imageId]=imageDetails[imageId];this.image(this.images[imageId]);this.openEditImageDetailsModal();}.bind(this)).fail(function(error){this.addMediaGridMessage('error',error);}.bind(this));return;}
if(this.image()&&this.image().id===imageId){this.openEditImageDetailsModal();return;}
this.image(this.images[imageId]);this.openEditImageDetailsModal();},openEditImageDetailsModal:function(){var modalElement=$(this.modalSelector);if(!modalElement.length||_.isUndefined(modalElement.modal)){return;}
this.setKeywordOptions(this.image().tags);this.newKeyword('');modalElement.modal('openModal');},closeImageDetailsModal:function(){var modalElement=$(this.modalSelector);if(!modalElement.length||_.isUndefined(modalElement.modal)){return;}
modalElement.modal('closeModal');},addMediaGridMessage:function(code,message){this.mediaGridMessages().add(code,message);this.mediaGridMessages().scheduleCleanup();},handleEnterKey:function(data,event){var modalElement=$(this.modalSelector),key=keyCodes[event.keyCode];if(key==='enterKey'){event.preventDefault();modalElement.find('.page-action-buttons button.save').click();}
return true;},removeCached:function(id){delete this.images[id];}});});