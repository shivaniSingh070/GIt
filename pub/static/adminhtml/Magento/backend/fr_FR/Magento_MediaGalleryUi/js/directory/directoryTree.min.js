define(['jquery','uiComponent','uiLayout','underscore','Magento_MediaGalleryUi/js/directory/actions/createDirectory','jquery/jstree/jquery.jstree','Magento_Ui/js/lib/view/utils/async'],function($,Component,layout,_,createDirectory){'use strict';return Component.extend({defaults:{allowedActions:[],filterChipsProvider:'componentType = filters, ns = ${ $.ns }',bookmarkProvider:'componentType = bookmark, ns = ${ $.ns }',directoryTreeSelector:'#media-gallery-directory-tree',getDirectoryTreeUrl:'media_gallery/directories/gettree',createDirectoryUrl:'media_gallery/directories/create',deleteDirectoryUrl:'media_gallery/directories/delete',jsTreeReloaded:null,modules:{bookmarks:'${ $.bookmarkProvider }',directories:'${ $.name }_directories',filterChips:'${ $.filterChipsProvider }'},listens:{'${ $.provider }:params.filters.path':'updateSelectedDirectory'},viewConfig:[{component:'Magento_MediaGalleryUi/js/directory/directories',name:'${ $.name }_directories',allowedActions:'${ $.allowedActions }'}]},initialize:function(){this._super().observe(['activeNode']).initView();$.async(this.directoryTreeSelector,this,function(){this.renderDirectoryTree().then(function(){this.initEvents();}.bind(this));}.bind(this));return this;},renderDirectoryTree:function(){return this.getJsonTree().then(function(data){this.createFolderIfNotExists(data).then(function(isFolderCreated){if(isFolderCreated){this.getJsonTree().then(function(newData){this.createTree(newData);}.bind(this));}else{this.createTree(data);}}.bind(this));}.bind(this));},setJsTreeReloaded:function(value){this.jsTreeReloaded=value;},createFolderIfNotExists:function(directories){var requestedDirectory=this.getRequestedDirectory(),deferred=$.Deferred(),pathArray;if(_.isNull(requestedDirectory)){deferred.resolve(false);return deferred.promise();}
if(this.isDirectoryExist(directories[0],requestedDirectory)){deferred.resolve(false);return deferred.promise();}
pathArray=this.convertPathToPathsArray(requestedDirectory);$.each(pathArray,function(i,val){if(this.isDirectoryExist(directories[0],val)){pathArray.splice(i,1);}}.bind(this));createDirectory(this.createDirectoryUrl,pathArray).then(function(){deferred.resolve(true);});return deferred.promise();},isDirectoryExist:function(directories,directoryId){var found=false;function recurse(data,id){var i;for(i=0;i<data.length;i++){if(data[i].attr.id===id){found=data[i];break;}else if(data[i].children&&data[i].children.length){recurse(data[i].children,id);}}}
recurse(directories,directoryId);return found;},convertPathToPathsArray:function(path){var pathsArray=[],pathString='',paths=path.split('/');$.each(paths,function(i,val){pathString+=i>=1?val:val+'/';pathsArray.push(i>=1?pathString:val);});return pathsArray;},initView:function(){layout(this.viewConfig);return this;},waitForCondition:function(condition,callback){if(condition()){setTimeout(function(){this.waitForCondition(condition,callback);}.bind(this),100);}else{callback();}},disableMultiselectBehavior:function(){$.jstree.defaults.ui['select_range_modifier']=false;$.jstree.defaults.ui['select_multiple_modifier']=false;},initEvents:function(){this.initJsTreeEvents();this.disableMultiselectBehavior();$(window).on('reload.MediaGallery',function(){this.getJsonTree().then(function(data){this.createFolderIfNotExists(data).then(function(isCreated){if(isCreated){this.renderDirectoryTree().then(function(){this.setJsTreeReloaded(true);this.initJsTreeEvents();}.bind(this));}else{this.updateSelectedDirectory();}}.bind(this));}.bind(this));}.bind(this));},initJsTreeEvents:function(){$(this.directoryTreeSelector).on('select_node.jstree',function(element,data){this.setActiveNodeFilter($(data.rslt.obj).data('path'));this.setJsTreeReloaded(false);}.bind(this));$(this.directoryTreeSelector).on('loaded.jstree',function(){this.updateSelectedDirectory();}.bind(this));},updateSelectedDirectory:function(){var currentFilterPath=this.filterChips().filters.path,requestedDirectory=this.getRequestedDirectory(),currentTreePath;if(_.isUndefined(currentFilterPath)){this.clearFiltersHandle();return;}
if(!_.isUndefined(this.bookmarks())){if(!_.size(this.bookmarks().getViewData(this.bookmarks().defaultIndex))){setTimeout(function(){this.updateSelectedDirectory();}.bind(this),500);return;}}
currentTreePath=this.isFilterApplied(currentFilterPath)||_.isNull(requestedDirectory)?currentFilterPath:requestedDirectory;if(this.folderExistsInTree(currentTreePath)){this.locateNode(currentTreePath);}else{this.selectStorageRoot();}},folderExistsInTree:function(path){if(!_.isUndefined(path)){return $('#'+path.replace(/\//g,'\\/')).length===1;}
return false;},getRequestedDirectory:function(){return!_.isUndefined(window.MediabrowserUtility)&&window.MediabrowserUtility.pathId!==''?Base64.idDecode(window.MediabrowserUtility.pathId):null;},isFilterApplied:function(currentFilterPath){return!_.isUndefined(currentFilterPath)&&currentFilterPath!=='';},locateNode:function(path){if(path===$(this.directoryTreeSelector).jstree('get_selected').attr('id')){return;}
path=path.replace(/\//g,'\\/');$(this.directoryTreeSelector).jstree('open_node','#'+path);$(this.directoryTreeSelector).jstree('select_node','#'+path,true);},clearFiltersHandle:function(){$(this.directoryTreeSelector).jstree('deselect_all');this.activeNode(null);this.directories().setInActive();},setActiveNodeFilter:function(nodePath){if(this.activeNode()===nodePath&&!this.jsTreeReloaded){this.selectStorageRoot();}else{this.selectFolder(nodePath);}},selectStorageRoot:function(){var filters={},applied=this.filterChips().get('applied');$(this.directoryTreeSelector).jstree('deselect_all');filters=$.extend(true,filters,applied);delete filters.path;this.filterChips().set('applied',filters);this.activeNode(null);this.waitForCondition(function(){return _.isUndefined(this.directories());}.bind(this),function(){this.directories().setInActive();}.bind(this));},selectFolder:function(path){this.activeNode(path);this.waitForCondition(function(){return _.isUndefined(this.directories());}.bind(this),function(){this.directories().setActive(path);}.bind(this));this.applyFilter(path);},removeNode:function(){$(this.directoryTreeSelector).jstree('remove');},applyFilter:function(path){var filters={},applied=this.filterChips().get('applied');filters=$.extend(true,filters,applied);filters.path=path;this.filterChips().set('applied',filters);},reloadJsTree:function(){var deferred=$.Deferred();this.getJsonTree().then(function(data){this.createTree(data);this.setJsTreeReloaded(true);this.initEvents();deferred.resolve();}.bind(this));return deferred.promise();},getJsonTree:function(){var deferred=$.Deferred();$.ajax({url:this.getDirectoryTreeUrl,type:'GET',dataType:'json',success:function(data){deferred.resolve(data);},error:function(jqXHR,textStatus){deferred.reject();throw textStatus;}});return deferred.promise();},createTree:function(data){$(this.directoryTreeSelector).jstree({plugins:['json_data','themes','ui','crrm','types','hotkeys'],vcheckbox:{'two_state':true,'real_checkboxes':true},'json_data':{data:data},hotkeys:{space:this._changeState,'return':this._changeState},types:{'types':{'disabled':{'check_node':true,'uncheck_node':true}}}});}});});