define(["jquery","knockout","Magento_Ui/js/lib/key-codes","underscore"],function(_jquery,_knockout,_keyCodes,_underscore){"use strict";_jquery=_interopRequireDefault(_jquery);_knockout=_interopRequireDefault(_knockout);_keyCodes=_interopRequireDefault(_keyCodes);_underscore=_interopRequireDefault(_underscore);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}
function stripHtml(html){if(html){var htmlDocument=new DOMParser().parseFromString(html,"text/html");return htmlDocument.body?htmlDocument.body.textContent:"";}
return html;}
function handlePlaceholderClass(element){if(stripHtml(element.innerHTML).length===0){element.innerHTML="";element.classList.add("placeholder-text");}else{element.classList.remove("placeholder-text");}}
_knockout.default.bindingHandlers.liveEdit={init:function init(element,valueAccessor,allBindings,viewModel,bindingContext){var _valueAccessor=valueAccessor(),field=_valueAccessor.field,placeholder=_valueAccessor.placeholder,_valueAccessor$select=_valueAccessor.selectAll,selectAll=_valueAccessor$select===void 0?false:_valueAccessor$select;var focusedValue=element.innerHTML;var previouslyFocused=false;var blurTimeout;var lastUpdateValue;var onFocus=function onFocus(){clearTimeout(blurTimeout);focusedValue=stripHtml(element.innerHTML);lastUpdateValue=focusedValue;if(selectAll&&element.innerHTML!==""&&!previouslyFocused){_underscore.default.defer(function(){var selection=window.getSelection();var range=document.createRange();range.selectNodeContents(element);selection.removeAllRanges();selection.addRange(range);previouslyFocused=true;});}};var onBlur=function onBlur(){blurTimeout=setTimeout(function(){previouslyFocused=false;},100);};var onMouseDown=function onMouseDown(event){event.stopPropagation();};var onKeyDown=function onKeyDown(event){var key=_keyCodes.default[event.keyCode];if(event.metaKey||event.ctrlKey){if(key==="bKey"||key==="iKey"||key==="uKey"){event.preventDefault();}}
if(key==="enterKey"){event.preventDefault();}
if(key==="pageLeftKey"||key==="pageRightKey"){event.stopPropagation();}};var onKeyUp=function onKeyUp(){var strippedValue=stripHtml(element.innerHTML);if(focusedValue!==strippedValue){lastUpdateValue=strippedValue;viewModel.updateData(field,strippedValue);}};var onDrop=function onDrop(event){event.preventDefault();};var onDragStart=function onDragStart(event){event.preventDefault();};var onInput=function onInput(){handlePlaceholderClass(element);};var onPaste=function onPaste(){var selection=window.getSelection();var originalPositionStart=selection.getRangeAt(0).cloneRange().startOffset;var originalPositionEnd=selection.getRangeAt(0).cloneRange().endOffset;var originalContentLength=stripHtml(element.innerHTML).length;_underscore.default.defer(function(){var strippedValue=stripHtml(element.innerHTML);lastUpdateValue=strippedValue;element.textContent=strippedValue;var restoredPosition=Math.abs(strippedValue.length-originalContentLength)+originalPositionStart;if(originalPositionStart!==originalPositionEnd){restoredPosition+=Math.abs(originalPositionEnd-originalPositionStart);}
var range=document.createRange();range.setStart(element.childNodes[0],restoredPosition);range.setEnd(element.childNodes[0],restoredPosition);selection.removeAllRanges();selection.addRange(range);});};element.setAttribute("data-placeholder",placeholder);element.textContent=viewModel.contentType.dataStore.get(field);element.contentEditable="true";element.addEventListener("focus",onFocus);element.addEventListener("blur",onBlur);element.addEventListener("mousedown",onMouseDown);element.addEventListener("keydown",onKeyDown);element.addEventListener("keyup",onKeyUp);element.addEventListener("input",onInput);element.addEventListener("drop",onDrop);element.addEventListener("paste",onPaste);element.addEventListener("dragstart",onDragStart);(0,_jquery.default)(element).parent().css("cursor","text");handlePlaceholderClass(element);viewModel.contentType.dataStore.subscribe(function(data){if(lastUpdateValue!==data[field]){lastUpdateValue=data[field];element.textContent=data[field];handlePlaceholderClass(element);}},field);if((0,_jquery.default)(element).parent().is("a")){(0,_jquery.default)(element).parent().attr("draggable","false");}},update:function update(element,valueAccessor,allBindings,viewModel,bindingContext){var _valueAccessor2=valueAccessor(),field=_valueAccessor2.field;element.textContent=viewModel.contentType.dataStore.get(field);handlePlaceholderClass(element);}};});