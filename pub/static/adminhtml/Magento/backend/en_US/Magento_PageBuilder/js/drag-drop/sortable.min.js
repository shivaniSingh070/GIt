define(["jquery","knockout","Magento_PageBuilder/js/events","Magento_PageBuilder/js/content-type-factory","Magento_PageBuilder/js/drag-drop/drop-indicators","Magento_PageBuilder/js/drag-drop/matrix","Magento_PageBuilder/js/drag-drop/move-content-type","Magento_PageBuilder/js/drag-drop/registry"],function(_jquery,_knockout,_events,_contentTypeFactory,_dropIndicators,_matrix,_moveContentType,_registry){var hiddenClass=".pagebuilder-content-type-hidden";function getSortableOptions(preview){return{cursor:"-webkit-grabbing",tolerance:"pointer",helper:function helper(event,item){var helper=(0,_jquery)(item).clone();helper.css({pointerEvents:"none"});return helper[0];},appendTo:document.body,placeholder:{element:function element(){return(0,_jquery)("<div />").addClass("pagebuilder-sortable-placeholder")[0];},update:function update(){return;}},handle:".move-structural",items:"> .pagebuilder-content-type-wrapper",start:function start(){onSortStart.apply(this,[preview].concat(Array.prototype.slice.call(arguments)));},sort:function sort(){onSort.apply(this,[preview].concat(Array.prototype.slice.call(arguments)));},receive:function receive(){onSortReceive.apply(this,[preview].concat(Array.prototype.slice.call(arguments)));},update:function update(){onSortUpdate.apply(this,[preview].concat(Array.prototype.slice.call(arguments)));},stop:function stop(){onSortStop.apply(this,[preview].concat(Array.prototype.slice.call(arguments)));}};}
function getPreviewStageIdProxy(preview){return preview.contentType.stageId;}
function getcontentTypeProxy(instance){return instance.contentType;}
var sortedContentType;function onSortStart(preview,event,ui){if(ui.item.hasClass("pagebuilder-content-type-wrapper")){_events.trigger("stage:interactionStart");var contentTypeInstance=_knockout.dataFor(ui.item[0]);if(contentTypeInstance){ui.item.css("display","block").addClass("pagebuilder-sorting-original");(0,_jquery)(".pagebuilder-drop-indicator.hidden-drop-indicator").css("display","block").removeClass("hidden-drop-indicator");if(contentTypeInstance.parentContentType.getChildren().indexOf(contentTypeInstance)===0){ui.item.prev(".pagebuilder-drop-indicator").css("display","none").addClass("hidden-drop-indicator");}
(0,_dropIndicators.showDropIndicators)(contentTypeInstance.config.name,preview.contentType.stageId);sortedContentType=contentTypeInstance;(0,_jquery)(this).sortable("option","connectWith",(0,_matrix.getAllowedContainersClasses)(contentTypeInstance.config.name,preview.contentType.stageId));(0,_jquery)(this).sortable("refresh");}}}
var placeholderContainer;function onSort(preview,event,ui){if((0,_jquery)(this).sortable("option","disabled")||ui.placeholder.parents(hiddenClass).length>0){ui.placeholder.css("display","none");}else{ui.placeholder.css("display","block");}
placeholderContainer=ui.placeholder.parents(".content-type-container")[0];}
function onSortStop(preview,event,ui){ui.item.removeClass("pagebuilder-sorting-original");(0,_dropIndicators.hideDropIndicators)();(0,_registry.setDraggedContentTypeConfig)(null);if(ui.item.hasClass("pagebuilder-content-type-wrapper")){_events.trigger("stage:interactionStop");}
if(ui.item&&!sortedContentType){ui.item.remove();}
sortedContentType=null;}
function onSortReceive(preview,event,ui){var contentTypeConfig=(0,_registry.getDraggedContentTypeConfig)();(0,_registry.setDraggedContentTypeConfig)(null);if((0,_jquery)(event.target)[0]!==this){return;}
if(!preview.isContainer()){(0,_jquery)(this).sortable("cancel");return;}
if(contentTypeConfig){if((0,_jquery)(this).sortable("option","disabled")||(0,_jquery)(this).parents(hiddenClass).length>0){return;}
var index=(0,_jquery)(event.target).children(".pagebuilder-content-type-wrapper, .pagebuilder-draggable-content-type").toArray().findIndex(function(element){return element.classList.contains("pagebuilder-draggable-content-type");});(0,_contentTypeFactory)(contentTypeConfig,getcontentTypeProxy(preview),getPreviewStageIdProxy(preview)).then(function(contentType){contentType.dropped=true;getcontentTypeProxy(preview).addChild(contentType,index);_events.trigger("contentType:dropAfter",{id:contentType.id,contentType:contentType});_events.trigger(contentTypeConfig.name+":dropAfter",{id:contentType.id,contentType:contentType});return contentType;});(0,_jquery)(event.target).find(".pagebuilder-draggable-content-type").remove();}}
function onSortUpdate(preview,event,ui){if((0,_jquery)(this).hasClass("ui-sortable")&&(0,_jquery)(this).sortable("option","disabled")||ui.item.parents(hiddenClass).length>0){ui.item.remove();(0,_jquery)(this).sortable("cancel");if(ui.item.length>0&&typeof _knockout.dataFor(ui.item[0])!=="undefined"){var data=_knockout.dataFor(ui.item[0]);var contentType=data.contentType&&data.contentType.getChildren?data.contentType:data.parentContentType;var children=contentType.getChildren()().splice(0);contentType.getChildren()([]);contentType.getChildren()(children);}
return;}
if(sortedContentType&&(this===ui.item.parent()[0]||placeholderContainer&&(0,_jquery)(this).find(ui.item.parent()).length>0)){var el=ui.item[0];var contentTypeInstance=_knockout.dataFor(el);var target=_knockout.dataFor(placeholderContainer);if(target&&contentTypeInstance){var sourceParent=contentTypeInstance.parentContentType;var targetParent=getcontentTypeProxy(target);var targetIndex=(0,_jquery)(placeholderContainer).children(".pagebuilder-content-type-wrapper, .pagebuilder-draggable-content-type").toArray().findIndex(function(element){return element===el;});if(sourceParent){(0,_jquery)(sourceParent===targetParent?this:ui.sender||this).sortable("cancel");}else{(0,_jquery)(el).remove();}
(0,_moveContentType.moveContentType)(contentTypeInstance,targetIndex,targetParent);if(contentTypeInstance.parentContentType!==targetParent){ui.item.remove();}}}}
return{getSortableOptions:getSortableOptions,hiddenClass:hiddenClass};});