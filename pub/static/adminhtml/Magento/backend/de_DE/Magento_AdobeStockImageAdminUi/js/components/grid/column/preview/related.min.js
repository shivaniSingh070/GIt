define(['uiComponent','underscore','jquery'],function(Component,_,$){'use strict';return Component.extend({defaults:{template:'Magento_AdobeStockImageAdminUi/grid/column/preview/related',filterChipsProvider:'componentType = filters, ns = ${ $.ns }',filterBookmarksSelector:'.admin__data-grid-action-bookmarks',tabImagesLimit:4,tabsContainerId:'#adobe-stock-tabs',serieFilterValue:'',modelFilterValue:'',selectedTab:null,loader:false,relatedImages:{series:{},model:{}},statefull:{serieFilterValue:true,modelFilterValue:true},modules:{chips:'${ $.chipsProvider }',filterChips:'${ $.filterChipsProvider }',preview:'${ $.parentName }.preview'},exports:{serieFilterValue:'${ $.provider }:params.filters.serie_id',modelFilterValue:'${ $.provider }:params.filters.model_id'}},initialize:function(){this._super();this.filterChips().updateActive();return this;},disableTabsKeyDownEvent:function(){if($(this.tabsContainerId+' li[role=tab]').length===0){setTimeout(function(){this.disableTabsKeyDownEvent();}.bind(this),100);}else{$(this.tabsContainerId+' li[role=tab]').off('keydown');}},initObservable:function(){this._super().observe(['serieFilterValue','modelFilterValue','selectedTab','relatedImages','loader']);return this;},isVisible:function(record){return this.showSeriesTab(record)&&this.showModelTab(record);},loadRelatedImages:function(record){var series=this.getSeries(record),model=this.getModel(record);if(series&&series.length||model&&model.length){return;}
$.ajax({type:'GET',url:this.preview().relatedImagesUrl,dataType:'json',beforeSend:function(){this.loader(true);}.bind(this),data:{'image_id':record.id,'limit':this.tabImagesLimit}}).done(function(data){var relatedImages=this.relatedImages();this.loader(false);relatedImages.series[record.id]=data.result['same_series'];relatedImages.model[record.id]=data.result['same_model'];this.relatedImages(relatedImages);this.preview().updateHeight();if(relatedImages.series[record.id].length===0&&relatedImages.model[record.id].length>0){$('#adobe-stock-tabs').data().mageTabs.select(1);}}.bind(this));},showSeriesTab:function(record){return typeof this.relatedImages().series[record.id]==='undefined'||this.relatedImages().series[record.id].length!==0;},showModelTab:function(record){return typeof this.relatedImages().model[record.id]==='undefined'||this.relatedImages().model[record.id].length!==0;},getSeries:function(record){return this.relatedImages().series[record.id]||[];},canShowMoreSeriesImages:function(record){return this.getSeries(record).length>=this.tabImagesLimit;},getModel:function(record){return this.relatedImages().model[record.id]||[];},canShowMoreModelImages:function(record){return this.getModel(record).length>=this.tabImagesLimit;},seeMoreFromSeries:function(record){if(this.isSerieFilterApplied(record)){this.scrollToFilter();return;}
this.serieFilterValue(record.id);this.applyFilter('serie_id',record.id.toString());},seeMoreFromModel:function(record){if(this.isModelFilterApplied(record)){this.scrollToFilter();return;}
this.modelFilterValue(record.id);this.applyFilter('model_id',record.id.toString());},applyFilter:function(typeId,recordId){var data={};data[typeId]=recordId;this.filterChips().clear();this.filterChips().setData(data,true);this.filterChips().apply();this.scrollToFilter();},isSerieFilterApplied:function(record){return this.filterChips().get('applied')['serie_id']===record.id.toString();},isModelFilterApplied:function(record){return this.filterChips().get('applied')['model_id']===record.id.toString();},scrollToFilter:function(){$(this.preview().adobeStockModalSelector+' '+this.filterBookmarksSelector).get(0).scrollIntoView({behavior:'smooth',block:'center',inline:'nearest'});},nextRelated:function(record){var relatedList=this.selectedTab()==='series'?this.getSeries(record):this.getModel(record),nextRelatedIndex=_.findLastIndex(relatedList,{id:this.preview().displayedRecord().id})+1,nextRelated=relatedList[nextRelatedIndex];if(typeof nextRelated==='undefined'){return;}
this.switchImagePreviewToRelatedImage(nextRelated);},prevRelated:function(record){var relatedList=this.selectedTab()==='series'?this.getSeries(record):this.getModel(record),prevRelatedIndex=_.findLastIndex(relatedList,{id:this.preview().displayedRecord().id})-1,prevRelated=relatedList[prevRelatedIndex];if(typeof prevRelated==='undefined'){return;}
this.switchImagePreviewToRelatedImage(prevRelated);},cannotViewPrevious:function(record){var relatedList,prevRelatedIndex,prevRelated;if(!this.selectedTab()){return false;}
relatedList=this.selectedTab()==='series'?this.getSeries(record):this.getModel(record);prevRelatedIndex=_.findLastIndex(relatedList,{id:this.preview().displayedRecord().id})-1;prevRelated=relatedList[prevRelatedIndex];return typeof prevRelated==='undefined';},cannotViewNext:function(record){var relatedList,nextRelatedIndex,nextRelated;if(!this.selectedTab()){return false;}
relatedList=this.selectedTab()==='series'?this.getSeries(record):this.getModel(record);nextRelatedIndex=_.findLastIndex(relatedList,{id:this.preview().displayedRecord().id})+1;nextRelated=relatedList[nextRelatedIndex];return typeof nextRelated==='undefined';},switchImagePreviewToRelatedImage:function(relatedImage){if(!relatedImage){this.selectedTab(null);return;}
if(this.preview().displayedRecord().id===relatedImage.id){return;}
this.preview().showRelated(relatedImage);},switchImagePreviewToSeriesImage:function(record){this.selectedTab('series');this.switchImagePreviewToRelatedImage(record);},switchImagePreviewToModelImage:function(record){this.selectedTab('model');this.switchImagePreviewToRelatedImage(record);}});});