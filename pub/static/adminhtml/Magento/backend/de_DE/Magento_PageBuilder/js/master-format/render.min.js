define(["jquery","Magento_PageBuilder/js/config","Magento_PageBuilder/js/master-format/render/serialize"],function(_jquery,_config,_serialize){var MasterFormatRenderer=function(){"use strict";function MasterFormatRenderer(stageId){this.ready=false;this.readyDeferred=_jquery.Deferred();this.stageId=stageId;}
var _proto=MasterFormatRenderer.prototype;_proto.applyBindings=function applyBindings(rootContainer){var _this=this;return new Promise(function(resolve,reject){if(!_this.getRenderFrame()){if(document.getElementById(_this.stageId)){return reject("No render frame present for Page Builder instance.");}
return reject();}
if(_this.ready){_this.channel.port1.postMessage({type:"render",message:{stageId:_this.stageId,tree:(0,_serialize.getSerializedTree)(rootContainer)}});_this.channel.port1.onmessage=function(event){if(event.isTrusted){if(event.data.type==="render"){resolve(event.data.message);}
if(event.data.type==="template"){_this.loadTemplate(event.data.message);}}else{reject("Render event was not trusted.");}};}else{_this.readyDeferred.then(function(){_this.applyBindings(rootContainer).then(function(rendered){resolve(rendered);}).catch(function(error){reject(error);});});}});};_proto.setupChannel=function setupChannel(){var _this2=this;this.channel=new MessageChannel();var frame=this.getRenderFrame();window.addEventListener("message",function(event){if(!_this2.ready&&event.data.name==="PB_RENDER_READY"&&_this2.stageId===event.data.stageId){frame.contentWindow.postMessage("PB_RENDER_PORT","*",[_this2.channel.port2]);_this2.ready=true;_this2.readyDeferred.resolve();}});frame.src=_config.getConfig("render_url")+"?stageId="+this.stageId;};_proto.loadTemplate=function loadTemplate(name){var _this3=this;require(["text!"+name],function(template){_this3.channel.port1.postMessage({type:"template",message:{name:name,template:template}});});};_proto.getRenderFrame=function getRenderFrame(){return document.getElementById("render_frame_"+this.stageId);};return MasterFormatRenderer;}();return MasterFormatRenderer;});