define(['jquery','uiComponent','mage/translate','jquery/ui','jquery/validate'],function($,Class,$t){'use strict';var pollTimer,windowOpen=false;return Class.extend({defaults:{$amazonFields:null,$amazonCredentialJson:null,$amazonSpBack:null,$amazonMerchantId:null,selector:'amazon_payment',$container:null,pollInterval:1500,$form:null,apSimplePathSelector:'#amazon_simplepath',apSimplePathBackSelector:'#amazon_simplepath_back',},initObservable:function(){var self=this;self.$amazonSimplepath=$(self.apSimplePathSelector);self.$amazonFields=$('#payment_'+self.getCountry()+'_'+self.selector+' .form-list');self.$amazonCredentialsHeader=$('#payment_'+self.getCountry()+'_'+self.selector
+'_credentials-head');self.$amazonCredentialJson=$('#payment_'+self.getCountry()+'_'+self.selector
+'_credentials_credentials_json');self.$amazonMerchantId=$('#payment_'+self.getCountry()+'_'+self.selector
+'_credentials_merchant_id').val();self.$amazonSpBack=$(self.apSimplePathBackSelector);self.$container=$(self.apSimplePathSelector);if(this.isMultiCurrencyRegion){$('#row_payment_'+self.getCountry()+'_amazon_payment_advanced_sales_options_multicurrency').show();$('#row_payment_other_amazon_payment_advanced_sales_options_multicurrency').show();}
else{$('#row_payment_'+self.getCountry()+'_amazon_payment_advanced_sales_options_multicurrency').hide();$('#row_payment_other_amazon_payment_advanced_sales_options_multicurrency').hide();}
if(self.$amazonMerchantId){self.hideAmazonConfig();}
else{self.showAmazonConfig();}
if(!self.$form){self.generateSimplePathForm();}
self._super();self.initEventHandlers();return self;},initEventHandlers:function(){var self=this;self.$amazonSpBack.click(function(){self.showAmazonConfig();return false;});$('#simplepath-skip').click(function(){self.hideAmazonConfig();return false;});$('#simplepath_form').on('submit',function(){$('#simplepath_form :input').each(function(){if($(this).attr('orig-name')){$(this).attr('name',$(this).attr('orig-name'));$(this).removeAttr('orig-name');}});self.setupWindowLaunch();});self.$amazonCredentialJson.on('input',function(){self.updateCredentials(self);});},updateCredentials:function(self){var elJson=self.$amazonCredentialJson.val(),obj=null,success=true,item=null;try{obj=$.parseJSON($.trim(elJson));}
catch(err){obj=null;self.$amazonCredentialJson.val('').attr('placeholder',$t('Invalid JSON credentials entered, please try again.')).focus();}
if(obj&&typeof obj==='object'){for(var prop in obj){if(obj.hasOwnProperty(prop)){item=$('#payment_'+self.getCountry()+'_amazon_payment_credentials_'
+$.trim(prop));if(item&&item.length){$('#payment_'+self.getCountry()+'_amazon_payment_credentials_'
+$.trim(prop)).val($.trim(obj[prop]));}
else{success=false;}}}
if(success){self.$amazonCredentialJson.val('').attr('placeholder',$t('Credential fields successfully updated and being saved.')).focus();$('#save').click();}
else{self.$amazonCredentialJson.val('').attr('placeholder',$t('One or more of your credential fields did not parse correctly. '+'Please review your entry and try again.')).focus();}}},setupWindowLaunch:function(){var self=this,heights=[660,720,810,900],popupWidth=this.getCountry()!=='us'?768:1050,popupHeight=heights[0],region=self.region,elCheckDefault=$('#payment_'+self.getCountry()
+'_amazon_payment_credentials_payment_region_inherit:checked'),elRegion=$('payment_'+self.getCountry()+'_amazon_payment_credentials_payment_region'),elJson=self.$amazonCredentialJson.val();for(var i in heights){if(heights.hasOwnProperty(i)){popupHeight=window.innerHeight>=heights[i]?heights[i]:popupHeight;}}
self.launchPopup(self.amazonUrl,popupWidth,popupHeight);windowOpen=true;pollTimer=setTimeout(self.pollForKeys(self),self.pollInterval);$('#save-json').click(function(e){e.stop();var json=$('#json-import').value;if(!json||!json.isJSON()){return;}
elJson.value=json;$('#save').click();});if(self.region.indexOf('eu')!==-1){region='de';}
if(elCheckDefault&&elCheckDefault.length){elCheckDefault[0].click();}
if(elRegion){elRegion.value=region;}},pollForKeys:function(self){clearTimeout(pollTimer);if(windowOpen){$.ajax({url:self.pollUrl,data:{},type:'GET',cache:true,dataType:'json',context:this,success:function(response){if(response){$('#amazon_reload').show();document.location.replace(document.location+'#payment_amazon_payments-head');location.reload();}
else{pollTimer=setTimeout(self.pollForKeys(self),self.pollInterval);}}});}},generateSimplePathForm:function(){this.$form=new Element('form',{method:'post',action:this.amazonUrl,id:'simplepath_form',target:'simplepath',novalidate:'novalidate',});this.$container.wrap(this.$form);for(var key in this.formParams){if($.isPlainObject(this.formParams[key])||$.isArray(this.formParams[key])){for(var i in this.formParams[key]){if(typeof this.formParams[key][i]!=='function'){$(new Element('input',{type:'hidden',name:key,value:this.formParams[key][i],novalidate:'novalidate'})).appendTo($("#simplepath_form"));}}}else{$(new Element('input',{type:'hidden',name:key,novalidate:'novalidate',value:this.formParams[key]})).appendTo($("#simplepath_form"));}}
$('#simplepath_form').validate({});},showAmazonConfig:function(){this.$amazonSimplepath.show();this.$amazonSpBack.hide();if(this.$amazonCredentialsHeader.hasClass('open')){this.$amazonCredentialsHeader.click();}},hideAmazonConfig:function(){this.$amazonSimplepath.hide();this.$amazonSpBack.show();if(!this.$amazonCredentialsHeader.hasClass('open')){this.$amazonCredentialsHeader.click();}},getCountry:function(){return this.co.toLowerCase();},launchPopup:function(url,requestedWidth,requestedHeight){var leftOffset=this.getLeftOffset(requestedWidth),topOffset=this.getTopOffset(requestedHeight),newWindow=window.open(url,'simplepath','scrollbars=yes, width='+requestedWidth
+', height='+requestedHeight+', top='+topOffset+', left='+leftOffset);if(window.focus){newWindow.focus();}
var winTimer=window.setInterval(function(){if(newWindow.closed!==false){window.clearInterval(winTimer);windowOpen=false;}});},getLeftOffset:function(requestedWidth){var dualScreenLeft=window.screenLeft!==undefined?window.screenLeft:screen.left;return(this.windowWidth()/ 2)-(requestedWidth / 2)+dualScreenLeft;},getTopOffset:function(requestedHeight){var dualScreenTop=window.screenTop!==undefined?window.screenTop:screen.top;return(this.windowHeight()/ 2)-(requestedHeight / 2)+dualScreenTop;},windowWidth:function(){return window.innerWidth||document.documentElement.clientWidth||screen.width;},windowHeight:function(){return window.innerHeight||document.documentElement.clientHeight||screen.height;}});});