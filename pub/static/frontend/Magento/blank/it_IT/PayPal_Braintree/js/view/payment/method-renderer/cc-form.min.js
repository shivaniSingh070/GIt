define(['underscore','jquery','Magento_Payment/js/view/payment/cc-form','Magento_Checkout/js/model/quote','PayPal_Braintree/js/view/payment/adapter','mage/translate','PayPal_Braintree/js/validator','PayPal_Braintree/js/view/payment/validator-handler','Magento_Checkout/js/model/full-screen-loader'],function(_,$,Component,quote,braintree,$t,validator,validatorManager,fullScreenLoader){'use strict';return Component.extend({defaults:{active:false,braintreeClient:null,braintreeDeviceData:null,paymentMethodNonce:null,lastBillingAddress:null,validatorManager:validatorManager,code:'braintree',isProcessing:false,additionalData:{},clientConfig:{dataCollector:{kount:true},onReady:function(context){context.setupHostedFields();},onPaymentMethodReceived:function(response){this.handleNonce(response);this.isProcessing=false;},onPaymentMethodError:function(){this.isProcessing=false;},onDeviceDataRecieved:function(deviceData){this.additionalData['device_data']=deviceData;},onInstanceReady:function(){},onError:function(response){this.isProcessing=false;braintree.showError($t('Payment '+this.getTitle()+' can\'t be initialized'));throw response.message;},onCancelled:function(){this.paymentMethodNonce=null;this.isProcessing=false;}},imports:{onActiveChange:'active'}},initObservable:function(){validator.setConfig(window.checkoutConfig.payment[this.getCode()]);this._super().observe(['active']);this.validatorManager.initialize();this.initClientConfig();return this;},getCode:function(){return this.code;},isActive:function(){var active=this.getCode()===this.isChecked();this.active(active);return active;},onActiveChange:function(isActive){if(!isActive){return;}
this.initBraintree();},initClientConfig:function(){if(this.hasFraudProtection()){this.clientConfig=_.extend(this.clientConfig,this.kountConfig());}
_.each(this.clientConfig,function(fn,name){if(typeof fn==='function'){this.clientConfig[name]=fn.bind(this);}},this);},initBraintree:function(){var intervalId=setInterval(function(){if($('#braintree-hosted-field-number').length){clearInterval(intervalId);fullScreenLoader.stopLoader(true);}},500);if(braintree.checkout){braintree.checkout.teardown(function(){braintree.checkout=null;});}
fullScreenLoader.startLoader();braintree.setConfig(this.clientConfig);braintree.setup();},kountConfig:function(){var config={dataCollector:{kount:{environment:this.getEnvironment()}},onReady:function(context){this.additionalData['device_data']=context.deviceData;context.setupHostedFields();}};if(this.getKountMerchantId()){config.dataCollector.kount.merchantId=this.getKountMerchantId();}
return config;},getSelector:function(field){return'#'+this.getCode()+'_'+field;},getCcAvailableTypes:function(){var availableTypes=validator.getAvailableCardTypes(),billingAddress=quote.billingAddress(),billingCountryId;this.lastBillingAddress=quote.shippingAddress();if(!billingAddress){billingAddress=this.lastBillingAddress;}
billingCountryId=billingAddress.countryId;if(billingCountryId&&validator.getCountrySpecificCardTypes(billingCountryId)){return validator.collectTypes(availableTypes,validator.getCountrySpecificCardTypes(billingCountryId));}
return availableTypes;},hasFraudProtection:function(){return window.checkoutConfig.payment[this.getCode()].hasFraudProtection;},getEnvironment:function(){return window.checkoutConfig.payment[this.getCode()].environment;},getKountMerchantId:function(){return window.checkoutConfig.payment[this.getCode()].kountMerchantId;},getData:function(){var data={'method':this.getCode(),'additional_data':{'payment_method_nonce':this.paymentMethodNonce,'g-recaptcha-response':$("#token-grecaptcha-braintree").val()}};data['additional_data']=_.extend(data['additional_data'],this.additionalData);return data;},setPaymentMethodNonce:function(paymentMethodNonce){this.paymentMethodNonce=paymentMethodNonce;},handleNonce:function(data){var self=this;this.setPaymentMethodNonce(data.nonce);self.validatorManager.validate(self,function(){return self.placeOrder('parent');},function(){self.isProcessing=false;self.paymentMethodNonce=null;});},placeOrder:function(key){if(key){return this._super();}
if(this.isProcessing){return false;}else{this.isProcessing=true;}
braintree.tokenizeHostedFields();return false;},getIcons:function(type){return window.checkoutConfig.payment.braintree.icons.hasOwnProperty(type)?window.checkoutConfig.payment.braintree.icons[type]:false;},});});