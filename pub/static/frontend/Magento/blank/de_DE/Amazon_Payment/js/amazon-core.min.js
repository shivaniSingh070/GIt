define(['jquery','ko','mage/url','amazonPaymentConfig','Magento_Ui/js/model/messageList','amazonWidgetsLoader','jquery/jquery-storageapi','mage/cookies'],function($,ko,url,amazonPaymentConfig,messageList){'use strict';var amazonDefined=ko.observable(false),amazonLoginError=ko.observable(false),accessToken=ko.observable(null),regions={'us':'NA','de':'EU','uk':'EU','jp':'APAC'},sandboxMode,region;accessToken($.mage.cookies.get('amazon_Login_accessToken'));var initAmazonLogin=function(){amazon.Login.setClientId(amazonPaymentConfig.getValue('clientId'));amazon.Login.setSandboxMode(amazonPaymentConfig.getValue('isSandboxEnabled',false));amazon.Login.setRegion(regions[amazonPaymentConfig.getValue('region')]);amazon.Login.setUseCookie(true);doLogoutOnFlagCookie();amazonDefined(true);};if(typeof amazon==='undefined'){window.onAmazonLoginReady=initAmazonLogin;}else{initAmazonLogin();}
window.onAmazonPaymentsReady=function(){$(window).trigger('OffAmazonPayments');};function amazonLogout(){$.mage.cookies.clear('amazon_Login_accessToken');$.ajax({url:url.build('amazon/logout'),context:this}).always(function(){if(amazonDefined()){amazon.Login.logout();}else{var logout=amazonDefined.subscribe(function(defined){if(defined){amazon.Login.logout();logout.dispose();}});}});}
function doLogoutOnFlagCookie(){var errorFlagCookie='amz_auth_err',amazonLogoutCookie='amz_auth_logout';$.cookieStorage.isSet(errorFlagCookie)?amazonLogoutThrowError(errorFlagCookie):false;$.cookieStorage.isSet(amazonLogoutCookie)?amazonLogoutThrowError(amazonLogoutCookie):false;}
function amazonLogoutThrowError(cookieToRemove){amazonLogout();document.cookie=cookieToRemove+'=; Path=/; expires=Thu, 01 Jan 1970 00:00:01 GMT;';amazonLoginError(true);}
function handleWidgetError(error){console.log('OffAmazonPayments.Widgets',error.getErrorCode(),error.getErrorMessage());switch(error.getErrorCode()){case'BuyerSessionExpired':messageList.addErrorMessage({message:$.mage.__('Your Amazon session has expired.  Please sign in again by clicking the Amazon Pay Button.')});var storage=require('Amazon_Payment/js/model/storage');storage.amazonlogOut();break;case'ITP':break;default:messageList.addErrorMessage({message:$.mage.__(error.getErrorMessage())});}}
return{AmazonLogout:amazonLogout,amazonDefined:amazonDefined,accessToken:accessToken,amazonLoginError:amazonLoginError,handleWidgetError:handleWidgetError};});