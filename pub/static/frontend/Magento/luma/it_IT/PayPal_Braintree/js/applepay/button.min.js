define(['uiComponent',"knockout","jquery",'braintree','braintreeApplePay','mage/translate'],function(Component,ko,jQuery,braintree,applePay,$t){'use strict';var that;return{init:function(element,context){if(!element||!context){return;}
if(typeof context.getClientToken!=='function'){console.error("Braintree ApplePay Context passed does not provide a getClientToken method",context);return;}
if(typeof context.getPaymentRequest!=='function'){console.error("Braintree ApplePay Context passed does not provide a getPaymentRequest method",context);return;}
if(typeof context.startPlaceOrder!=='function'){console.error("Braintree ApplePay Context passed does not provide a startPlaceOrder method",context);return;}
if(this.deviceSupported()===false){return;}
braintree.create({authorization:context.getClientToken()},function(clientErr,clientInstance){if(clientErr){console.error('Error creating client:',clientErr);return;}
applePay.create({client:clientInstance},function(applePayErr,applePayInstance){if(applePayErr){console.error('Braintree ApplePay Error creating applePayInstance:',applePayErr);return;}
var el=document.createElement('div');el.className="braintree-apple-pay-button";el.title=$t("Pay with Apple Pay");el.alt=$t("Pay with Apple Pay");el.addEventListener('click',function(e){e.preventDefault();var paymentRequest=applePayInstance.createPaymentRequest(context.getPaymentRequest());if(!paymentRequest){alert($t("We're unable to take payments through Apple Pay at the moment. Please try an alternative payment method."));console.error('Braintree ApplePay Unable to create paymentRequest',paymentRequest);return;}
jQuery("body").loader('show');try{var session=new ApplePaySession(1,paymentRequest);}catch(err){jQuery("body").loader('hide');console.error('Braintree ApplePay Unable to create ApplePaySession',err);alert($t("We're unable to take payments through Apple Pay at the moment. Please try an alternative payment method."));return false;}
session.onvalidatemerchant=function(event){applePayInstance.performValidation({validationURL:event.validationURL,displayName:context.getDisplayName()},function(validationErr,merchantSession){if(validationErr){session.abort();console.error('Braintree ApplePay Error validating merchant:',validationErr);alert($t("We're unable to take payments through Apple Pay at the moment. Please try an alternative payment method."));return;}
session.completeMerchantValidation(merchantSession);});};session.onpaymentauthorized=function(event){applePayInstance.tokenize({token:event.payment.token},function(tokenizeErr,payload){if(tokenizeErr){console.error('Error tokenizing Apple Pay:',tokenizeErr);session.completePayment(ApplePaySession.STATUS_FAILURE);return;}
context.startPlaceOrder(payload.nonce,event,session);});};if(typeof context.onShippingContactSelect==='function'){session.onshippingcontactselected=function(event){return context.onShippingContactSelect(event,session);};}
if(typeof context.onShippingMethodSelect==='function'){session.onshippingmethodselected=function(event){return context.onShippingMethodSelect(event,session);};}
if(typeof context.onButtonClick==='function'){context.onButtonClick(session,this,e);}else{jQuery("body").loader('hide');session.begin();}});element.appendChild(el);});});},deviceSupported:function(){if(location.protocol!='https:'){console.warn("Braintree Apple Pay requires your checkout be served over HTTPS");return false;}
if((window.ApplePaySession&&ApplePaySession.canMakePayments())!==true){console.warn("Braintree Apple Pay is not supported on this device/browser");return false;}
return true;}};});